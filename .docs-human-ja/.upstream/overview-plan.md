# プロジェクト概要計画

**プロジェクト名**: Traffic jam-reducing city-building web game  
**日付**: 2026-01-24  
**仕様**: [.upstream/overview-spec.md](.upstream/overview-spec.md)  

## 要約

この計画は、渋滞解消に焦点を当てたブラウザベースの2D都市建設ゲームの全体的な開発アプローチを概説し、経済物流シミュレーションへと進化するものです。プロジェクトは憲法からのテストファースト（TDD）、統合テスト、最小変更スコープの原則を強調した段階的な開発プロセスに従います。主要な目標には60 FPSパフォーマンスの達成、堅牢なセキュリティ、魅力的なゲームプレイが含まれ、Cloudflare Pagesでホストされるシングルプレイヤー体験です。

## 開発フェーズ

1. **研究と計画（1-2ヶ月）**: 類似ゲームの市場調査を行い、PixiJS/bitECSスタックに基づく技術アーキテクチャを最終決定し、詳細な機能仕様を定義。タイムライン: 2026年2-3月。
2. **設計とプロトタイピング（2-3ヶ月）**: UI/UXデザインを作成し、コアメカニクス（都市建設、物流）をプロトタイプし、BunとAstroで開発環境をセットアップ。タイムライン: 2026年4-6月。
3. **実装（4-6ヶ月）**: TDDを使用して機能を反復的に開発し、基本的な都市建設と物流シミュレーションから開始。セキュリティ対策とローカライズを統合。タイムライン: 2026年7-12月。
4. **テストと最適化（2-3ヶ月）**: PlaywrightでE2Eテストを実行し、60 FPS向けに最適化し、セキュリティ監査を実施し、ゲームプレイバランスを洗練。タイムライン: 2027年1-3月。
5. **デプロイメントとローンチ（1ヶ月）**: Cloudflare Pagesにデプロイし、New Relicで監視し、初期ユーザーフィードバックを収集。タイムライン: 2027年4月。

## リスクと緩和策

- **パフォーマンス問題**: 複雑なシミュレーションにより60 FPSを達成できないリスク。緩和策: PixiJSでの早期プロトタイピングとプロファイリング; bitECSでECSを最適化。
- **セキュリティ脆弱性**: ウェブベースのゲームがクライアントサイドのエクスプロイトに脆弱。緩和策: 権威あるサーバーステート、アンチチートヒューリスティック、定期監査を実装。
- **スコープクリープ**: 基本ゲームから完全な物流シミュレーションへの進化。緩和策: 最小変更スコープに準拠; 詳細な機能計画にSpecKitを使用。
- **ブラウザ互換性**: IndexedDB/WebGLサポートの変動。緩和策: モダンブラウザ間でテスト; 可能な限りフォールバックを提供。
- **チーム可用性**: 指定スタックの開発者専門知識への依存。緩和策: チームトレーニングを確保し、必要に応じて採用を検討。

## 依存関係

- **技術スタック可用性**: PixiJS、bitECS、Bun、Astro、Cloudflare Pages、New Relic、Playwrightがアクセス可能で維持されること。
- **チームスキル**: TypeScript、ECSパターン、ウェブセキュリティに精通した開発者。
- **規制**: ウェブプライバシー法（例: データ最小化のためのGDPR）の遵守。
- **外部サービス**: Cloudflareでの安定したホスティング; New Relicによる監視。

## マイルストーン

- **マイルストーン1**: 研究と仕様最終決定の完了（2026年3月末）。
- **マイルストーン2**: 基本的な都市建設でのプロトタイプデモ（2026年6月末）。
- **マイルストーン3**: 物流と交通削減のコア実装（2026年12月末）。
- **マイルストーン4**: 完全なテストと最適化（2027年3月末）。
- **マイルストーン5**: ローンチとポストローンチ監視（2027年4月末）。

## 主要機能の詳細実装計画

このセクションは、仕様で概説された主要機能の実装計画をより深く提供し、必要なコンテキスト、コンポーネント、テスト戦略に焦点を当てます。各機能は明示的な契約を持つ自己完結型のコンテキストとして設計され、関数型スタイルのインターフェースと依存性注入に従います。実装はテストファースト（TDD）と重要な領域の統合テストに従います。

### 1. 都市建設と管理
**コンテキスト**: `src/libs/core/` 下のコアゲームドメインで、bitECSをエンティティ管理に使用。建物は位置、タイプ、リソース、ユーティリティのコンポーネントを持つエンティティです。

**必要なコンポーネント**:
- 建物配置システム: 道路隣接の検証、重複防止。
- リソース管理: 建物タイプごとの水道、電気、ガスの追跡。
- 永続化: IndexedDBへの建物状態の保存。

**実装ステップ**:
1. ECSコンポーネントを定義（例: Position, BuildingType, Resources）。
2. 配置ロジックを実装（チェックのための純粋関数）。
3. PixiJS経由のレンダリングのためのシーン管理と統合。
4. 建物選択と配置のためのUIを追加。

**テスト戦略**: 配置ロジックのユニットテスト; ECS更新と永続化の統合テスト。PlaywrightでのUIインタラクションのE2Eテスト。

**依存関係**: レンダリングのためのPixiJS、ECSのためのbitECS、ストレージのためのIndexedDB。

### 2. 物流と輸送
**コンテキスト**: `src/libs/core/ecs/` 下のシミュレーションドメインで、車両をエンティティとしてサプライチェーンをモデル化。

**必要なコンポーネント**:
- 車両ルーティング: 交通を考慮した道路のパスファインディングアルゴリズム。
- 在庫管理: 生産、ストレージ、配布。
- インポート/エクスポート: 地元供給が失敗した場合のフォールバックメカニズム。

**実装ステップ**:
1. 在庫コンポーネントを持つECSエンティティとして生産施設と店舗をモデル化。
2. オーダーマッチングと車両派遣を実装（ロジックのための純粋関数）。
3. コスト計算で輸送オプション（鉄道、船舶、航空）を追加。
4. 渋滞効果のための交通シミュレーションを統合。

**テスト戦略**: ルーティングアルゴリズムのTDD; 完全なサプライチェーンサイクルの統合テスト。インポート/エクスポートのための時間ベースイベントのシミュレーション。

**依存関係**: エンティティのためのbitECS、必要に応じたカスタムパスファインディングライブラリ、状態のためのIndexedDB。

### 3. 交通と渋滞の削減
**コンテキスト**: `src/libs/core/scenes/management.ts` 下の最適化コンテキストで、リアルタイムシミュレーションに焦点。

**必要なコンポーネント**:
- 渋滞計算: 車両密度と道路容量に基づく。
- ルート最適化: 渋滞を減らすための動的パス調整。
- フィードバックループ: プレイヤーアクションが交通フローに影響。

**実装ステップ**:
1. 交通フロー模型を実装（簡略化された物理ベース）。
2. 渋滞レベルとプレイヤースコアリングのメトリクスを追加。
3. インフラアップグレードのためのツールを提供（例: 新しい道路）。
4. 経済的影響とのバランス。

**テスト戦略**: 高車両数での60 FPSのパフォーマンステスト; 計算関数のユニットテスト。最適化効果のE2E。

**依存関係**: 可視化のためのPixiJS、エンティティ更新のためのbitECS。

### 4. 経済シミュレーション
**コンテキスト**: `src/libs/core/` 下のビジネスロジックで、トランザクションのための契約。

**必要なコンポーネント**:
- 生産サイクル: 時間ベースの商品作成。
- 市場ダイナミクス: 価格設定での供給/需要バランス。
- チェーンリアクション: 物流を通じた失敗の伝播。

**実装ステップ**:
1. 生産レートを持つ経済エンティティ（工場、店舗）を定義。
2. トランザクションロジックを実装（計算のための純粋関数）。
3. 経済イベントを追加（例: 需要スパイク）。
4. 住民消費と統合。

**テスト戦略**: 経済モデルのユニットテスト; 完全サイクルの統合テスト。シミュレーションのためのモック時間。

**依存関係**: エンティティのためのbitECS、カスタム数学ライブラリ。

### 5. 住民とビジネスシミュレーション
**コンテキスト**: `src/libs/core/` 下のAI/行動コンテキストで、自律エージェントをシミュレート。

**必要なコンポーネント**:
- 住民行動: 住宅、仕事、消費。
- ビジネス運営: 雇用、在庫回転。
- 人口ダイナミクス: 出生、移動、ビジネス失敗。

**実装ステップ**:
1. 状態マシンを持つECSエンティティとして住民とビジネスをモデル化。
2. 決定ロジックを実装（例: 仕事探し、ショッピング）。
3. ライフサイクルイベントを追加（例: 建物放棄）。
4. 都市リソースとのバランス。

**テスト戦略**: 行動ロジックのTDD; 創発行動の統合テスト。全体的な都市健康のE2E。

**依存関係**: エージェントのためのbitECS、公平性のためのセキュアな乱数ジェネレーター。

### 6. インフラユーティリティ
**コンテキスト**: `src/libs/core/config/` 下のサポートコンテキストで、市全体のサービスを管理。

**必要なコンポーネント**:
- ユーティリティグリッド: 容量を持つ電力、水道ネットワーク。
- 駐車と移動性: 割り当てシステム。
- アップグレード: 改善のためのプレイヤー投資。

**実装ステップ**:
1. ユーティリティコンポーネントとグリッドロジックを定義。
2. 割り当てアルゴリズムを実装（例: 駐車割り当て）。
3. ユーティリティステータスの可視化を追加。
4. 建物要件と統合。

**テスト戦略**: グリッド計算のユニットテスト; 市全体効果の統合テスト。大規模グリッドのパフォーマンステスト。

**依存関係**: マップのためのPixiJS、コンポーネントのためのbitECS。

**全体的な注意**: 各機能は外部サービス（例: 永続化）の依存性注入を使用。変更はロールバック計画で可逆。セキュリティ監査でハードコード値なし。詳細仕様についてはSpecKitエージェントを参照。