# 渋滞解消街作りWebゲーム 憲法
<!-- 例: Spec Constitution, TaskFlow Constitution 等 -->

## 中核原則

### I. ドキュメント
- 開発ドキュメントは基本的に英語で作成し、適切なディレクトリ（例: プロジェクトルート、`.specify/`、`specs/`、`.upstream/` など）に配置すること。
- 新しく開発ドキュメントを作成した場合は `AGENTS.md` に必ずリンクを追加すること。
- 例外として日本語訳ファイルは `.docs-human-ja/` にルートからのパスを模倣して配置してよい。
- 日本語訳ファイルは `AGENTS.md` にリンクを記載しないこと。
- 英日ドキュメントでは英語ドキュメントを原本とし、翻訳は直ちに同一内容に保つこと。
- 英語ドキュメントを正本とし、日本語訳は英語原本のニュアンス・意図・意味を忠実に保持し、その忠実性を確認すること。

### II. Don't be Evil ポリシー
- シニアエンジニアとして深い洞察を発揮し、厳密で詳細な分析を行い、誠実で信頼できる成果物と、明確かつ根拠のある回答を提供する。
- ユーザーの希望に迎合するよりも、科学的事実、公式ドキュメント、最近（原則として過去6か月以内）の最新情報を優先すること。
- 表面的・基礎的な説明ではなく、専門的で深い洞察を提供すること。
- 不確実性、仮定、推測、未解決事項（TODO）は必ず明示し、勝手に埋めず、不明な場合は「不明」と表記し追加情報や調査方針を提示すること。
- 性能・安全性・保守性・運用上の制約やリスクも隠さず早期に共有すること。
- 誤解を招く行為や重要な挙動・制約を意図的に不透明にすることを禁止する。
- 変更指示があった場合はまず既存の周辺コードを確認し、実装不要なら実装を避け、その旨を明示すること。

### III. コンテキスト優先（Context-First）
- すべての機能は実行コンテキストを起点に考えること：コンポーネントは自己完結で、独立してテスト可能、文書化されていること。組織専用のコンポーネントは避けること。
- ファイル・関数・変数・定数・インターフェイス・型などコード中の要素を作る／変更するたびに、その所属コンテキストを確認し記録すること。
- コンテキスト間のやり取りは最小限に抑え、明確な契約で行うこと：関数シグネチャ、`module-as-record`、型付きDTO、APIスキーマなどの関数型表現を優先する。クラスや状態を持つオブジェクトは例外的に採用し、その理由を設計書に必ず明記すること。
- 小さいコンテキストは目的・責務に応じて最も近いコンテキストに所属させてよい。
- 分割自体が目的にならないこと。ファイル数が増えるだけの分割は避けること。

### IV. テストファースト & 統合テスト
- テストファースト（TDD）を必須とする：まずテストを書き、適切なステークホルダー／オーナーの承認を得て、テストが失敗することを確認してから実装を行う。Red-Green-Refactor のサイクルを厳密に守ること。
- 統合テストは重要領域で必須とする：新しいライブラリの契約テスト、契約変更、サービス間通信、共有スキーマ等。
- コードの変更・削除時には影響範囲を広くとり、静的解析および単体テストで検証すること。
- 狭義の影響範囲だと見落としが発生するため、間接的に依存している可能性のある全領域（ビルドスクリプト、共有ユーティリティ、消費されるスキーマ、デプロイマニフェスト等）を必ずチェックすること。

### V. ランタイムファースト思考
- API・バッチ・CLI などのランタイムアーティファクトは、デプロイ構成、オブザーバビリティ、障害モード、レート制限など本番実行環境を前提に設計すること。
- 設定値（シークレット・エンドポイント・フラグ等）はハードコードしてはならず、環境変数や設定プロバイダ等の外部設定として扱うこと。
- ログ・メトリクス・トレースなどの可観測性はデバッガをアタッチせずとも本番障害を診断できるレベルで準備すること。
- 外部契約（API、メッセージスキーマ等）や永続データに影響する変更は後方互換性とマイグレーションパスを必ず評価すること。

### VI. 最小変更のスコープ原則
- まずは最小変更で試し（例: 環境変数の一時置換など）、要求を満たせないと分かった段階で段階的にスコープを広げること。拡大ステップは都度記録し、可逆性を意識すること。

## 基本原則

1. 定数および純粋関数を優先し、副作用を最小限に抑える
2. 副作用のある関数は `wse` (WithSideEffect の略) を接頭辞とする
3. グローバル変数およびシングルトンは厳禁。必要になったらグローバルストアを優先
4. 関数型記述を優先し、可能な限り純粋関数と module-as-record で実装する。これらの関数型表現では限界を越えてしまい表現しきれない内部状態・ライフサイクル・多態性が明確に必要な場合のみclass/interfaceを採用する
5. 依存は外部から注入し、契約は関数シグネチャ／モジュール（関数群のレコード）／プロトコル等で明示する（DI必須）
6. テスト容易性を優先し、テスト容易性が損なわれる実装は禁止
7. 単一責任原則に則り、一つのコンテキスト、一つの関数には特定の責任のみを持たせる。別の責任が必要な場合は、どんなに処理が類似していても別のコンテキスト、別の関数を用意する
8. 型安全性／null安全性を最大限活用し、不正な状態をそもそも表現できないようにする
9. 発生することが分かっているかつcatch後のリカバリー処理が明確な時に限定してtry{}catch{}を実装するようにし、それ以外は実行環境に例外処理を任せる
10. イベント命名: 発行側は現在進行形、受信側は過去形
11. リテラル文字列/マジックナンバーは直接使わず、定数化して使用する
12. 外部API/DBスキーマ/インフラに依存する層ではAdapterパターンを使用する
13. ユニットテストは純粋関数の正常系・異常系・境界テストをカバー；副作用/外部依存は統合テストに移行；1000ケースを超えてもユニットテストは爆速を維持
14. ファイルヘッダー、関数、型定義にはjsdoc様のコメントを付ける
15. コメントは最小限。暗黙の了解や裏読みが必要な部分を中心に記述。「なぜこのコードが今この形なのか」を現在の外部制約・仕様・他コードとの関係性から説明。コードの理由を過去の経緯から持ってくるのは禁止
16. 表現可能な型範囲内で特別な意味を割り当てる場合、値と意味を明示的に文書化する（例: -1 や INT_MIN をエラー/無効マーカーとして使用、または `int` ステータス値に別々の意味を付与）
17. `package.json`、`tsconfig.json`、ロックファイル、ベース設定などの標準ツールで生成可能なファイルは手動で書かず、対応するCLIで生成する（例: `pnpm init`、`tsc --init`、各種フレームワークジェネレータ）
18. 戻り値にnullまたはundefinedを含めるのは最後の手段。原則として型で表現可能な範囲内で適切なデフォルト値（intなら0、stringなら空文字列など）を設定する
19. ネストはできる限り浅くなるようにする
20. 常に早期returnし、本命処理を実施可能かの分岐を関数内で事前に済ませておく

## 技術特性

### 技術スタック
- PixiJS（2D レンダリング）
- bitECS（ECS ランタイム）
- bun（ビルド／パッケージ／ユニットテスト）
- Cloudflare Pages（ホスティング）
- Astro（ベースフレームワーク）
- New Relic（エラー収集のみ）
- Playwright（UI / E2E テスト）
- ブラウザ内 IndexedDB（セーブデータ用、localStorage は使用しない）

### ディレクトリ構成
すべてのソースコードは `src/` 配下に置く:

```
src/
    pages/
        index.astro    # /play へのリンクのみ
        play.astro
    app/
        bootstrap.ts    # play.astro で表示するゲームの bootstrap
    libs/    # ゲーム用ライブラリ
        features/
            title/
                scene.ts
            config/
                scene.ts
            play/
                scene.ts
        core/    # ゲームのドメインロジック
            scenes/
                management.ts
            ecs/
            config/
            persistence/
        instructures/
        utilities/
```

### プロジェクト構造
- 関心の分離が明確なモジュラーアーキテクチャ
- libs/features/ 配下の機能ベースの組織化
- ECS、config、persistence を伴う libs/core/ 配下のコアドメインlogic
- 共有モジュールとしての utilities と infrastructures
- Context-First 設計: 各モジュールは単一の責任を持ち、独立してテスト可能

### パフォーマンス
- 目標 FPS: 60
- ロードが1秒以上かかっている場合、一旦ロード画面に移行する
- 処理が重くなってきた場合、1フレームで処理する数を制限して複数フレームで一周するようにする
- 頻繁に作成/破棄されるオブジェクトにはオブジェクトプーリングを使用する
- 非同期アセット読み込みを進捗追跡付きで実装する
- メモリ使用量の監視とガベージコレクションのためのクリーンアップヒント
- 表示: めちゃくちゃ簡易な2Dグラフィックス

### ローカライズ
- 対応言語: 英語、 日本語

### スケーラビリティ
- 主にクライアントサイドのゲームでサーバ負荷が最小限
- グローバル配信とスケーラビリティのために Cloudflare Pages でホスティング
- この規模ではマイクロサービスは不要；モノリシックなクライアントサイドアーキテクチャで十分

### 監視
- New Relic を使用した本番インシデントのエラーモニタリング
- クライアントサイドのパフォーマンスメトリクス（FPS、ロード時間、メモリ使用量）
- ゲームプレイ分析のためのユーザーインタラクションログ
- デバッグと問題追跡のための集中ログ

### セキュリティ

#### 一般的な Web セキュリティ（重要な箇所は必須）
- **HTTPS/TLS（必須）:** すべてのページ、API、アセットを TLS 経由で配信し、HSTS と近代的な暗号スイートを有効にすること。
- **Content Security Policy（CSP、推奨）:** XSS リスクを減らすためにスクリプト・スタイル・ソースの起点を制限すること。可能な場合は第三者リソースに SRI を適用する。
- **CORS（必須）:** API に対して厳格なオリジンポリシーを適用し、過度に寛容な設定は避けること。
- **入力検証・出力エンコーディング（必須）:** サーバー側で検証・正規化し、クライアント入力を信用しないこと。
- **認証・セッション（必須）:** セキュアな短寿命トークン、適切な Cookie フラグ（HttpOnly, Secure, SameSite）、ローテーション/失効機構を用いること。
- **レート制限・不正検知（必須）:** ブルートフォースや自動化による悪用からエンドポイントを保護すること（グローバルおよびエンドポイント単位の制御）。
- **秘密情報管理（必須）:** 秘密をハードコードしない。環境変数や専用のシークレットストアを使用しアクセスを制限すること。
- **依存関係のセキュリティ（推奨）:** 自動脆弱性スキャン、バージョン固定、メジャーアップデートの方針を設定すること。
- **ログ・監視（必須）:** 中央集約されたログ、セキュリティ関連のメトリクス、疑わしい活動やエラーに対するアラートを用意すること。
- **WAF / エッジ保護（推奨）:** CDN/WAF の機能で DDoS 緩和や基本的なリクエストフィルタリングを活用すること。

#### Webゲーム固有の考慮事項
- **サーバー権威の状態（必須）:** ゲームの重要な状態はサーバー側を権威とし、すべてのクライアントからの操作をサーバー側で検証してチートを防ぐこと。
- **アンチチート・改竄検知（推奨／要検討）:** ヒューリスティックや異常検知、サーバー側検証を実装する。クライアント側の難読化のみを当てにしないこと。
- **アセット整合性・バージョニング（推奨）:** 署名付きやバージョン付きマニフェストを用いて改竄されたアセットが配信されないようにすること。
- **予測可能な RNG と公平性（公平性が重要な場合は必須）:** 予測可能な乱数シードをクライアントに公開しないこと。乱数はサーバー側で生成するか暗号的に安全な方法を用いること。
- **入力のバッチ処理・スロットリング（推奨）:** ボットや自動化されたプレイを防ぐため、高頻度の操作をスロットリングしサーバー側検証を行うこと。
- **プライバシー・データ最小化（必須）:** PII は最小限に収集し、保存は必要最小限にし保持・削除方針を実装すること。
- **ゲーム状態のマイグレーション安全性（必須）:** プレイヤー進行に影響するスキーマ変更のマイグレーションパスを計画し、回復やロールバック戦略を用意すること。
- **クライアント側難読化（単独では非推奨）:** 難読化は抑止効果はあるが根拠とはならないため、単独対策としては不十分であることを認識すること。

## ガバナンス

- 憲法はプロジェクトの最終的な指針であり、暫定的な慣習より優先される。
- 修正は文書化された PR と明確な理由、（コードやデータに影響がある場合は）移行／ロールアウト計画を含めて提案すること。修正は少なくとも 2 名のメンテナまたはプロジェクトリードの承認を必要とする。
- バージョニングはセマンティックバージョンに従うこと：MAJOR はガバナンス破壊的変更、MINOR は原則追加や実質的拡張、PATCH は表現の明確化など。
- 準拠性：憲法の管理下にある領域に影響する PR は関連セクションを参照し、遵守を示す（テスト、ドキュメント、または理由）こと。メンテナは憲法に違反するマージをブロックできる。
- レビューの周期：憲法は年次レビューを行うか、重大なインシデントが発生した場合に見直すこと。

**Version**: 1.0.0 | **Ratified**: 2026-01-19 | **Last Amended**: 2026-01-19
