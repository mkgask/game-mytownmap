# 渋滞解消街作りWebゲーム 憲法
<!-- 例: Spec Constitution, TaskFlow Constitution 等 -->

## 中核原則

### I. ドキュメント
開発ドキュメントは基本的に英語で作成し、プロジェクトルート、`.specify/`、または `specs/` に配置すること。新しく開発ドキュメントを作成した場合は `AGENTS.md` に必ずリンクを追加すること。例外として日本語訳ファイルは `.docs-human-ja/` にルートからのパスを模倣して配置してよい。英日ドキュメントでは英語ドキュメントを原本とし、翻訳は直ちに同一内容に保つこと。ドキュメントルールにそぐわない状況を発見した場合は速やかに修正すること。

### II. Don't be Evil ポリシー
- シニアエンジニアとして誠実さと技術的判断を持ち、詳細で根拠ある分析と成果物を提供すること。
- ユーザーの希望に迎合するよりも、科学的事実、公式ドキュメント、最近（原則として過去6か月以内）の最新情報を優先すること。
- 表面的・基礎的な説明ではなく、専門的で深い洞察を提供すること。
- 不確実性、仮定、推測、未解決事項（TODO）は必ず明示し、勝手に埋めず、不明な場合は「不明」と表記し追加情報や調査方針を提示すること。
- 性能・安全性・保守性・運用上の制約やリスクも隠さず早期に共有すること。
- 誤解を招く行為や重要な挙動・制約を意図的に不透明にすることを禁止する。
- 変更指示があった場合はまず既存の周辺コードを確認し、実装不要なら実装を避け、その旨を明示すること。

### III. コンテキスト優先（Context-First）
- すべての機能は実行コンテキストを起点に考えること：コンポーネントは自己完結で、独立してテスト可能、文書化されていること。組織専用のコンポーネントは避けること。
- ファイル・関数・変数・定数・インターフェイス・型などコード中の要素を作る／変更するたびに、その所属コンテキストを確認し記録すること。
- コンテキスト間のやり取りは最小限に抑え、明確な契約で行うこと：関数シグネチャ、`module-as-record`、型付きDTO、APIスキーマなどの関数型表現を優先する。クラスや状態を持つオブジェクトは例外的に採用し、その理由を設計書に必ず明記すること。
- 小さいコンテキストは目的・責務に応じて最も近いコンテキストに所属させてよい。
- 分割自体が目的にならないこと。ファイル数が増えるだけの分割は避けること。

### IV. テストファースト & 統合テスト
- テストファースト（TDD）を必須とする：まずテストを書き、適切なステークホルダー／オーナーの承認を得て、テストが失敗することを確認してから実装を行う。Red-Green-Refactor のサイクルを厳密に守ること。
- 統合テストは重要領域で必須とする：新しいライブラリの契約テスト、契約変更、サービス間通信、共有スキーマ等。
- コードの変更・削除時には影響範囲を広くとり、静的解析および単体テストで検証すること。
- 狭義の影響範囲だと見落としが発生するため、間接的に依存している可能性のある全領域（ビルドスクリプト、共有ユーティリティ、消費されるスキーマ、デプロイマニフェスト等）を必ずチェックすること。

### V. ランタイムファースト思考
- API・バッチ・CLI などのランタイムアーティファクトは、デプロイ構成、オブザーバビリティ、障害モード、レート制限など本番実行環境を前提に設計すること。
- 設定値（シークレット・エンドポイント・フラグ等）はハードコードしてはならず、環境変数や設定プロバイダ等の外部設定として扱うこと。
- ログ・メトリクス・トレースなどの可観測性はデバッガをアタッチせずとも本番障害を診断できるレベルで準備すること。
- 外部契約（API、メッセージスキーマ等）や永続データに影響する変更は後方互換性とマイグレーションパスを必ず評価すること。

### VI. 最小変更のスコープ原則
- まずは最小変更で試し（例: 環境変数の一時置換など）、要求を満たせないと分かった段階で段階的にスコープを広げること。拡大ステップは都度記録し、可逆性を意識すること。

## 技術特性

### 技術スタック
- PixiJS（2D レンダリング）
- bitECS（ECS ランタイム）
- bun（ビルド／パッケージ／ユニットテスト）
- Cloudflare Pages（ホスティング）
- Astro（ベースフレームワーク）
- New Relic（エラー収集のみ）
- Playwright（UI / E2E テスト）
- ブラウザ内 IndexedDB（セーブデータ用、localStorage は使用しない）

### ディレクトリ構成
すべてのソースコードは `src/` 配下に置く:

```
src/
    pages/
        index.astro    # /play へのリンクのみ
        play.astro
    app/
        bootstrap.ts    # play.astro で表示するゲームの bootstrap
    libs/    # ゲーム用ライブラリ
        features/
            title/
                scene.ts
            config/
                scene.ts
            play/
                scene.ts
        core/    # ゲームのドメインロジック
            scenes/
                management.ts
            ecs/
            config/
            persistence/
        instructures/
        utilities/
```

### パフォーマンス
- 目標 FPS: 60

### ローカライズ
- 対応言語: 英語、 日本語

### セキュリティ

#### 一般的な Web セキュリティ（重要な箇所は必須）
- **HTTPS/TLS（必須）:** すべてのページ、API、アセットを TLS 経由で配信し、HSTS と近代的な暗号スイートを有効にすること。
- **Content Security Policy（CSP、推奨）:** XSS リスクを減らすためにスクリプト・スタイル・ソースの起点を制限すること。可能な場合は第三者リソースに SRI を適用する。
- **CORS（必須）:** API に対して厳格なオリジンポリシーを適用し、過度に寛容な設定は避けること。
- **入力検証・出力エンコーディング（必須）:** サーバー側で検証・正規化し、クライアント入力を信用しないこと。
- **認証・セッション（必須）:** セキュアな短寿命トークン、適切な Cookie フラグ（HttpOnly, Secure, SameSite）、ローテーション/失効機構を用いること。
- **レート制限・不正検知（必須）:** ブルートフォースや自動化による悪用からエンドポイントを保護すること（グローバルおよびエンドポイント単位の制御）。
- **秘密情報管理（必須）:** 秘密をハードコードしない。環境変数や専用のシークレットストアを使用しアクセスを制限すること。
- **依存関係のセキュリティ（推奨）:** 自動脆弱性スキャン、バージョン固定、メジャーアップデートの方針を設定すること。
- **ログ・監視（必須）:** 中央集約されたログ、セキュリティ関連のメトリクス、疑わしい活動やエラーに対するアラートを用意すること。
- **WAF / エッジ保護（推奨）:** CDN/WAF の機能で DDoS 緩和や基本的なリクエストフィルタリングを活用すること。

#### Webゲーム固有の考慮事項
- **サーバー権威の状態（必須）:** ゲームの重要な状態はサーバー側を権威とし、すべてのクライアントからの操作をサーバー側で検証してチートを防ぐこと。
- **アンチチート・改竄検知（推奨／要検討）:** ヒューリスティックや異常検知、サーバー側検証を実装する。クライアント側の難読化のみを当てにしないこと。
- **アセット整合性・バージョニング（推奨）:** 署名付きやバージョン付きマニフェストを用いて改竄されたアセットが配信されないようにすること。
- **予測可能な RNG と公平性（公平性が重要な場合は必須）:** 予測可能な乱数シードをクライアントに公開しないこと。乱数はサーバー側で生成するか暗号的に安全な方法を用いること。
- **入力のバッチ処理・スロットリング（推奨）:** ボットや自動化されたプレイを防ぐため、高頻度の操作をスロットリングしサーバー側検証を行うこと。
- **プライバシー・データ最小化（必須）:** PII は最小限に収集し、保存は必要最小限にし保持・削除方針を実装すること。
- **ゲーム状態のマイグレーション安全性（必須）:** プレイヤー進行に影響するスキーマ変更のマイグレーションパスを計画し、回復やロールバック戦略を用意すること。
- **クライアント側難読化（単独では非推奨）:** 難読化は抑止効果はあるが根拠とはならないため、単独対策としては不十分であることを認識すること。

## ガバナンス

- 憲法はプロジェクトの最終的な指針であり、暫定的な慣習より優先される。
- 修正は文書化された PR と明確な理由、（コードやデータに影響がある場合は）移行／ロールアウト計画を含めて提案すること。修正は少なくとも 2 名のメンテナまたはプロジェクトリードの承認を必要とする。
- バージョニングはセマンティックバージョンに従うこと：MAJOR はガバナンス破壊的変更、MINOR は原則追加や実質的拡張、PATCH は表現の明確化など。
- 準拠性：憲法の管理下にある領域に影響する PR は関連セクションを参照し、遵守を示す（テスト、ドキュメント、または理由）こと。メンテナは憲法に違反するマージをブロックできる。
- レビューの周期：憲法は年次レビューを行うか、重大なインシデントが発生した場合に見直すこと。

**Version**: 1.0.0 | **Ratified**: 2026-01-19 | **Last Amended**: 2026-01-19
